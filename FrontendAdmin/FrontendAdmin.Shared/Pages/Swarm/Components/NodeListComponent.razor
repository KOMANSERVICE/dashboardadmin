@using FrontendAdmin.Shared.Pages.Swarm.Models
@using IDR.Library.Blazor.Buttons
@using IDR.Library.Blazor.Enums

<div class="bg-white shadow-md rounded-lg overflow-hidden">
    <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
                <tr>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Noeud</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Role</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Etat</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Disponibilite</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Docker</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Resources</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200">
                @if (!Nodes.Any())
                {
                    <tr>
                        <td colspan="7" class="px-6 py-8 text-center text-gray-500">
                            <i class="fas fa-server text-4xl mb-2"></i>
                            <p>Aucun noeud Docker Swarm</p>
                        </td>
                    </tr>
                }
                else
                {
                    @foreach (var node in Nodes)
                    {
                        <tr class="hover:bg-gray-50 transition">
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="flex items-center">
                                    <i class="@GetNodeIcon(node.Role) text-primary-700 mr-3"></i>
                                    <div>
                                        <div class="text-sm font-medium text-gray-900">@node.Hostname</div>
                                        <div class="text-sm text-gray-500">@node.Id[..12]</div>
                                    </div>
                                </div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <span class="@GetRoleBadgeClass(node.Role) px-2 inline-flex text-xs leading-5 font-semibold rounded-full">
                                    @node.Role
                                </span>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <span class="@GetStateBadgeClass(node.State) px-2 inline-flex text-xs leading-5 font-semibold rounded-full">
                                    @node.State
                                </span>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <span class="@GetAvailabilityBadgeClass(node.Availability) px-2 inline-flex text-xs leading-5 font-semibold rounded-full">
                                    @node.Availability
                                </span>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                @node.EngineVersion
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                <div>
                                    <span class="font-medium">CPU:</span> @FormatCpu(node.NanoCPUs)
                                </div>
                                <div>
                                    <span class="font-medium">RAM:</span> @FormatMemory(node.MemoryBytes)
                                </div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="flex gap-1">
                                    <Button type="button" @onclick="() => OnViewDetails.InvokeAsync(node)"
                                            ButtonColor="ButtonColor.Light"
                                            IconCss="fas fa-eye" IconPlacement="ButtonIconPlacement.Left"
                                            title="Voir details">
                                    </Button>
                                    <Button type="button" @onclick="() => OnEditLabels.InvokeAsync(node)"
                                            ButtonColor="ButtonColor.Warning"
                                            IconCss="fas fa-tags" IconPlacement="ButtonIconPlacement.Left"
                                            title="Gerer labels">
                                    </Button>
                                    <Button type="button" @onclick="() => OnManageNode.InvokeAsync(node)"
                                            ButtonColor="ButtonColor.Primary"
                                            IconCss="fas fa-cogs" IconPlacement="ButtonIconPlacement.Left"
                                            title="Actions">
                                    </Button>
                                </div>
                            </td>
                        </tr>
                    }
                }
            </tbody>
            @if (Nodes.Any())
            {
                <tfoot class="bg-gray-100">
                    <tr>
                        <td colspan="7" class="px-6 py-3">
                            <div class="flex items-center gap-4 text-sm flex-wrap">
                                <span class="font-medium text-gray-700">Total:</span>
                                <span class="bg-primary-100 text-primary-800 px-2 py-1 rounded">
                                    @Nodes.Count noeud(s)
                                </span>
                                <span class="bg-purple-100 text-purple-800 px-2 py-1 rounded">
                                    @Nodes.Count(n => n.Role.ToLower() == "manager") manager(s)
                                </span>
                                <span class="bg-blue-100 text-blue-800 px-2 py-1 rounded">
                                    @Nodes.Count(n => n.Role.ToLower() == "worker") worker(s)
                                </span>
                                <span class="bg-green-100 text-green-800 px-2 py-1 rounded">
                                    @Nodes.Count(n => n.State.ToLower() == "ready") ready
                                </span>
                                <span class="bg-gray-200 text-gray-700 px-2 py-1 rounded">
                                    <i class="fas fa-microchip mr-1"></i>@FormatCpuTotal(Nodes.Sum(n => n.NanoCPUs))
                                </span>
                                <span class="bg-gray-200 text-gray-700 px-2 py-1 rounded">
                                    <i class="fas fa-memory mr-1"></i>@FormatMemory(Nodes.Sum(n => n.MemoryBytes))
                                </span>
                            </div>
                        </td>
                    </tr>
                </tfoot>
            }
        </table>
    </div>
</div>

@code {
    [Parameter] public List<NodeDto> Nodes { get; set; } = new();
    [Parameter] public EventCallback<NodeDto> OnViewDetails { get; set; }
    [Parameter] public EventCallback<NodeDto> OnEditLabels { get; set; }
    [Parameter] public EventCallback<NodeDto> OnManageNode { get; set; }

    private string GetNodeIcon(string role)
    {
        return role.ToLower() switch
        {
            "manager" => "fas fa-crown",
            "worker" => "fas fa-cog",
            _ => "fas fa-server"
        };
    }

    private string GetRoleBadgeClass(string role)
    {
        return role.ToLower() switch
        {
            "manager" => "bg-purple-100 text-purple-800",
            "worker" => "bg-blue-100 text-blue-800",
            _ => "bg-gray-100 text-gray-800"
        };
    }

    private string GetStateBadgeClass(string state)
    {
        return state.ToLower() switch
        {
            "ready" => "bg-green-100 text-green-800",
            "down" => "bg-red-100 text-red-800",
            "disconnected" => "bg-yellow-100 text-yellow-800",
            _ => "bg-gray-100 text-gray-800"
        };
    }

    private string GetAvailabilityBadgeClass(string availability)
    {
        return availability.ToLower() switch
        {
            "active" => "bg-green-100 text-green-800",
            "pause" => "bg-yellow-100 text-yellow-800",
            "drain" => "bg-red-100 text-red-800",
            _ => "bg-gray-100 text-gray-800"
        };
    }

    private string FormatCpu(long nanoCpus)
    {
        var cpus = nanoCpus / 1_000_000_000.0;
        return $"{cpus:F1} cores";
    }

    private string FormatCpuTotal(long nanoCpus)
    {
        var cpus = nanoCpus / 1_000_000_000.0;
        return $"{cpus:F0} CPU";
    }

    private string FormatMemory(long memoryBytes)
    {
        var gb = memoryBytes / (1024.0 * 1024 * 1024);
        return $"{gb:F1} GB";
    }
}

@using FrontendAdmin.Shared.Pages.Swarm.Models
@inject ISwarmHttpService SwarmService

<div class="p-4">
    <div class="mb-4">
        <h3 class="text-lg font-semibold text-gray-900">Executer une commande</h3>
        <p class="text-sm text-gray-500">Conteneur: @ContainerName</p>
    </div>

    <div class="space-y-4">
        <!-- Formulaire de commande -->
        <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Commande</label>
            <div class="flex gap-2">
                <input type="text" @bind="command" @onkeyup="HandleKeyUp"
                       placeholder="ex: ls -la, cat /etc/hosts, ps aux"
                       class="flex-1 px-3 py-2 border rounded-lg focus:ring-2 focus:ring-primary-500 font-mono" />
                <Button type="button" @onclick="ExecuteCommand" ButtonColor="ButtonColor.Primary" disabled="@(isExecuting || string.IsNullOrWhiteSpace(command))">
                    @if (isExecuting)
                    {
                        <i class="fas fa-spinner animate-spin mr-2"></i>
                    }
                    else
                    {
                        <i class="fas fa-play mr-2"></i>
                    }
                    Executer
                </Button>
            </div>
        </div>

        <!-- Repertoire de travail optionnel -->
        <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Repertoire de travail (optionnel)</label>
            <input type="text" @bind="workingDir"
                   placeholder="ex: /app, /var/log"
                   class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-primary-500 font-mono" />
        </div>

        <!-- Historique des commandes -->
        @if (commandHistory.Any())
        {
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Historique</label>
                <div class="flex flex-wrap gap-2">
                    @foreach (var cmd in commandHistory.TakeLast(5))
                    {
                        <button @onclick="() => command = cmd"
                                class="px-2 py-1 bg-gray-100 hover:bg-gray-200 rounded text-sm font-mono">
                            @cmd
                        </button>
                    }
                </div>
            </div>
        }

        <!-- Resultat -->
        @if (execResult != null)
        {
            <div class="space-y-2">
                <div class="flex items-center gap-2">
                    <span class="text-sm font-medium text-gray-700">Resultat:</span>
                    <span class="@(execResult.ExitCode == 0 ? "bg-green-100 text-green-800" : "bg-red-100 text-red-800") px-2 py-0.5 rounded text-xs font-semibold">
                        Exit code: @execResult.ExitCode
                    </span>
                    <span class="text-xs text-gray-500">@execResult.ExecutedAt.ToString("HH:mm:ss")</span>
                </div>

                @if (!string.IsNullOrEmpty(execResult.Stdout))
                {
                    <div>
                        <span class="text-xs text-gray-500 block mb-1">stdout:</span>
                        <div class="bg-gray-900 text-green-400 p-3 rounded-lg font-mono text-sm overflow-auto max-h-[300px]">
                            <pre class="whitespace-pre-wrap break-all">@execResult.Stdout</pre>
                        </div>
                    </div>
                }

                @if (!string.IsNullOrEmpty(execResult.Stderr))
                {
                    <div>
                        <span class="text-xs text-gray-500 block mb-1">stderr:</span>
                        <div class="bg-gray-900 text-red-400 p-3 rounded-lg font-mono text-sm overflow-auto max-h-[200px]">
                            <pre class="whitespace-pre-wrap break-all">@execResult.Stderr</pre>
                        </div>
                    </div>
                }
            </div>
        }

        @if (!string.IsNullOrEmpty(errorMessage))
        {
            <div class="p-4 bg-red-50 text-red-700 rounded-md">
                @errorMessage
            </div>
        }
    </div>

    <div class="flex justify-end mt-6">
        <Button type="button" @onclick="OnClose" ButtonColor="ButtonColor.Light">
            <span>Fermer</span>
        </Button>
    </div>
</div>

@code {
    [Parameter] public string ContainerId { get; set; } = "";
    [Parameter] public string ContainerName { get; set; } = "";
    [Parameter] public EventCallback OnClose { get; set; }

    private string command = "";
    private string? workingDir;
    private bool isExecuting = false;
    private string? errorMessage;
    private ContainerExecResponseDto? execResult;
    private List<string> commandHistory = new();

    private async Task ExecuteCommand()
    {
        if (string.IsNullOrWhiteSpace(command)) return;

        isExecuting = true;
        errorMessage = null;
        execResult = null;

        try
        {
            var request = new ContainerExecRequest(
                Command: command,
                WorkingDir: string.IsNullOrWhiteSpace(workingDir) ? null : workingDir
            );

            var response = await SwarmService.ExecContainerAsync(ContainerId, request);

            if (response.Success)
            {
                execResult = response.Data.Response;

                // Add to history if not already there
                if (!commandHistory.Contains(command))
                {
                    commandHistory.Add(command);
                }
            }
            else
            {
                errorMessage = response.Message;
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Erreur: {ex.Message}";
        }
        finally
        {
            isExecuting = false;
            StateHasChanged();
        }
    }

    private async Task HandleKeyUp(KeyboardEventArgs e)
    {
        if (e.Key == "Enter")
        {
            await ExecuteCommand();
        }
    }
}

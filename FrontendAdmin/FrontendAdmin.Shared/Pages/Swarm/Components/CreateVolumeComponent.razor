@using FrontendAdmin.Shared.Pages.Swarm.Models
@using System.ComponentModel.DataAnnotations
@inject ISwarmHttpService SwarmService

<div class="p-4">
    <EditForm Model="@model" OnValidSubmit="HandleSubmit">
        <DataAnnotationsValidator />

        <div class="space-y-4">
            <!-- Volume Name -->
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Nom du volume *</label>
                <InputText @bind-Value="model.Name"
                           class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-primary-700 focus:border-transparent"
                           placeholder="mon-volume" />
                <ValidationMessage For="() => model.Name" class="text-red-500 text-sm mt-1" />
            </div>

            <!-- Driver -->
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Driver</label>
                <select @bind="model.Driver"
                        class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-primary-700 focus:border-transparent">
                    <option value="local">local</option>
                    <option value="nfs">nfs</option>
                    <option value="tmpfs">tmpfs</option>
                </select>
            </div>

            <!-- Labels -->
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Labels (optionnel)</label>
                <div class="space-y-2">
                    @foreach (var label in labels)
                    {
                        <div class="flex gap-2">
                            <input type="text" @bind="label.Key"
                                   class="flex-1 border border-gray-300 rounded-md px-3 py-2 text-sm"
                                   placeholder="Cle" />
                            <input type="text" @bind="label.Value"
                                   class="flex-1 border border-gray-300 rounded-md px-3 py-2 text-sm"
                                   placeholder="Valeur" />
                            <button type="button" @onclick="() => RemoveLabel(label)"
                                    class="text-red-500 hover:text-red-700 px-2">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    }
                    <button type="button" @onclick="AddLabel"
                            class="text-primary-700 hover:text-primary-800 text-sm">
                        <i class="fas fa-plus mr-1"></i> Ajouter un label
                    </button>
                </div>
            </div>
        </div>

        @if (!string.IsNullOrEmpty(errorMessage))
        {
            <div class="mt-4 p-3 bg-red-100 text-red-700 rounded-md text-sm">
                <i class="fas fa-exclamation-triangle mr-2"></i>@errorMessage
            </div>
        }

        <div class="flex justify-end gap-2 mt-6">
            <Button type="button" @onclick="OnCancel" ButtonColor="ButtonColor.Light">
                <span>Annuler</span>
            </Button>
            <Button type="submit" ButtonColor="ButtonColor.Primary" Disabled="@isSubmitting">
                @if (isSubmitting)
                {
                    <span class="animate-spin mr-2"><i class="fas fa-spinner"></i></span>
                }
                <span>Creer</span>
            </Button>
        </div>
    </EditForm>
</div>

@code {
    [Parameter] public EventCallback OnVolumeCreated { get; set; }
    [Parameter] public EventCallback OnCancel { get; set; }

    private CreateVolumeModel model = new();
    private List<LabelEntry> labels = new();
    private bool isSubmitting;
    private string? errorMessage;

    private class CreateVolumeModel
    {
        [Required(ErrorMessage = "Le nom du volume est requis")]
        [RegularExpression(@"^[a-zA-Z0-9][a-zA-Z0-9_.-]*$", ErrorMessage = "Nom invalide")]
        public string Name { get; set; } = "";
        public string Driver { get; set; } = "local";
    }

    private class LabelEntry
    {
        public string Key { get; set; } = "";
        public string Value { get; set; } = "";
    }

    private void AddLabel()
    {
        labels.Add(new LabelEntry());
    }

    private void RemoveLabel(LabelEntry label)
    {
        labels.Remove(label);
    }

    private async Task HandleSubmit()
    {
        isSubmitting = true;
        errorMessage = null;
        StateHasChanged();

        try
        {
            var labelsDict = labels
                .Where(l => !string.IsNullOrWhiteSpace(l.Key))
                .ToDictionary(l => l.Key, l => l.Value);

            var request = new CreateVolumeRequest(
                Name: model.Name,
                Driver: model.Driver,
                Labels: labelsDict.Any() ? labelsDict : null
            );

            var response = await SwarmService.CreateVolumeAsync(request);

            if (response.Success)
            {
                await OnVolumeCreated.InvokeAsync();
            }
            else
            {
                errorMessage = response.Message ?? "Erreur lors de la creation du volume";
            }
        }
        catch (Exception ex)
        {
            errorMessage = ex.Message;
        }
        finally
        {
            isSubmitting = false;
            StateHasChanged();
        }
    }
}

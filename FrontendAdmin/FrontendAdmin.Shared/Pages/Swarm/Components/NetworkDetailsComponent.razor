@using FrontendAdmin.Shared.Pages.Swarm.Models
@inject ISwarmHttpService SwarmService

<div class="p-4">
    @if (isLoading)
    {
        <div class="flex justify-center items-center py-8">
            <i class="fas fa-spinner fa-spin text-2xl text-primary-700"></i>
        </div>
    }
    else if (networkDetails != null)
    {
        <div class="space-y-4">
            <!-- Basic Info -->
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="text-sm font-medium text-gray-500">Nom</label>
                    <p class="text-gray-900">@networkDetails.Name</p>
                </div>
                <div>
                    <label class="text-sm font-medium text-gray-500">Driver</label>
                    <p>
                        <span class="@GetDriverBadgeClass(networkDetails.Driver) px-2 inline-flex text-xs leading-5 font-semibold rounded-full">
                            @networkDetails.Driver
                        </span>
                    </p>
                </div>
                <div>
                    <label class="text-sm font-medium text-gray-500">Scope</label>
                    <p class="text-gray-900">@networkDetails.Scope</p>
                </div>
                <div>
                    <label class="text-sm font-medium text-gray-500">Cree le</label>
                    <p class="text-gray-900">@networkDetails.CreatedAt.ToString("dd/MM/yyyy HH:mm:ss")</p>
                </div>
            </div>

            <!-- ID -->
            <div>
                <label class="text-sm font-medium text-gray-500">ID</label>
                <p class="text-gray-900 break-all bg-gray-50 p-2 rounded text-sm font-mono">@networkDetails.Id</p>
            </div>

            <!-- Flags -->
            <div>
                <label class="text-sm font-medium text-gray-500">Proprietes</label>
                <div class="mt-1 flex flex-wrap gap-2">
                    @if (networkDetails.IsInternal)
                    {
                        <span class="bg-gray-100 text-gray-700 px-2 py-1 rounded text-sm">
                            <i class="fas fa-lock mr-1"></i>Interne
                        </span>
                    }
                    @if (networkDetails.IsAttachable)
                    {
                        <span class="bg-blue-100 text-blue-700 px-2 py-1 rounded text-sm">
                            <i class="fas fa-plug mr-1"></i>Attachable
                        </span>
                    }
                </div>
            </div>

            <!-- IPAM Configuration -->
            @if (!string.IsNullOrEmpty(networkDetails.Subnet) || !string.IsNullOrEmpty(networkDetails.Gateway) || !string.IsNullOrEmpty(networkDetails.IpRange))
            {
                <div>
                    <label class="text-sm font-medium text-gray-500">Configuration IPAM</label>
                    <div class="mt-1 bg-gray-50 rounded p-3 grid grid-cols-3 gap-4">
                        @if (!string.IsNullOrEmpty(networkDetails.Subnet))
                        {
                            <div>
                                <span class="text-xs text-gray-500">Subnet</span>
                                <p class="font-mono text-sm">@networkDetails.Subnet</p>
                            </div>
                        }
                        @if (!string.IsNullOrEmpty(networkDetails.Gateway))
                        {
                            <div>
                                <span class="text-xs text-gray-500">Gateway</span>
                                <p class="font-mono text-sm">@networkDetails.Gateway</p>
                            </div>
                        }
                        @if (!string.IsNullOrEmpty(networkDetails.IpRange))
                        {
                            <div>
                                <span class="text-xs text-gray-500">IP Range</span>
                                <p class="font-mono text-sm">@networkDetails.IpRange</p>
                            </div>
                        }
                    </div>
                </div>
            }

            <!-- Connected Containers -->
            @if (networkDetails.Containers.Any())
            {
                <div>
                    <label class="text-sm font-medium text-gray-500">Conteneurs connectes (@networkDetails.Containers.Count)</label>
                    <div class="mt-1 bg-gray-50 rounded overflow-hidden">
                        <table class="w-full text-sm">
                            <thead class="bg-gray-100">
                                <tr>
                                    <th class="px-3 py-2 text-left text-xs font-medium text-gray-500">Nom</th>
                                    <th class="px-3 py-2 text-left text-xs font-medium text-gray-500">Adresse IP</th>
                                    <th class="px-3 py-2 text-left text-xs font-medium text-gray-500">MAC</th>
                                    <th class="px-3 py-2 text-right text-xs font-medium text-gray-500">Actions</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-gray-200">
                                @foreach (var container in networkDetails.Containers)
                                {
                                    <tr class="hover:bg-gray-100">
                                        <td class="px-3 py-2">
                                            <div class="flex items-center">
                                                <i class="fas fa-cube text-blue-500 mr-2"></i>
                                                <span class="font-medium">@container.ContainerName</span>
                                            </div>
                                        </td>
                                        <td class="px-3 py-2 font-mono text-gray-600">@(container.IpAddress ?? "N/A")</td>
                                        <td class="px-3 py-2 font-mono text-gray-600 text-xs">@(container.MacAddress ?? "N/A")</td>
                                        <td class="px-3 py-2 text-right">
                                            <button @onclick="() => DisconnectContainer(container.ContainerId)"
                                                    class="text-red-500 hover:text-red-700 text-xs"
                                                    title="Deconnecter">
                                                @if (disconnectingContainerId == container.ContainerId)
                                                {
                                                    <i class="fas fa-spinner fa-spin"></i>
                                                }
                                                else
                                                {
                                                    <i class="fas fa-unlink"></i>
                                                }
                                            </button>
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            }
            else
            {
                <div class="text-center text-gray-500 py-4">
                    <i class="fas fa-cube text-2xl mb-2"></i>
                    <p class="text-sm">Aucun conteneur connecte</p>
                </div>
            }

            <!-- Labels -->
            @if (networkDetails.Labels.Any())
            {
                <div>
                    <label class="text-sm font-medium text-gray-500">Labels</label>
                    <div class="mt-1 bg-gray-50 rounded p-2">
                        <table class="w-full text-sm">
                            @foreach (var label in networkDetails.Labels)
                            {
                                <tr>
                                    <td class="font-mono text-gray-600 pr-4">@label.Key</td>
                                    <td class="font-mono text-gray-900 break-all">@label.Value</td>
                                </tr>
                            }
                        </table>
                    </div>
                </div>
            }

            <!-- Options -->
            @if (networkDetails.Options.Any())
            {
                <div>
                    <label class="text-sm font-medium text-gray-500">Options</label>
                    <div class="mt-1 bg-gray-50 rounded p-2">
                        <table class="w-full text-sm">
                            @foreach (var option in networkDetails.Options)
                            {
                                <tr>
                                    <td class="font-mono text-gray-600 pr-4">@option.Key</td>
                                    <td class="font-mono text-gray-900 break-all">@option.Value</td>
                                </tr>
                            }
                        </table>
                    </div>
                </div>
            }
        </div>

        @if (!string.IsNullOrEmpty(errorMessage))
        {
            <div class="mt-4 p-3 bg-red-100 text-red-700 rounded-md text-sm">
                <i class="fas fa-exclamation-triangle mr-2"></i>@errorMessage
            </div>
        }

        @if (!string.IsNullOrEmpty(successMessage))
        {
            <div class="mt-4 p-3 bg-green-100 text-green-700 rounded-md text-sm">
                <i class="fas fa-check-circle mr-2"></i>@successMessage
            </div>
        }

        <div class="flex justify-end mt-6">
            <Button type="button" @onclick="OnClose" ButtonColor="ButtonColor.Light">
                <span>Fermer</span>
            </Button>
        </div>
    }
    else
    {
        <div class="text-center text-red-600 py-4">
            <i class="fas fa-exclamation-triangle text-2xl mb-2"></i>
            <p>Erreur lors du chargement des details du reseau</p>
        </div>
    }
</div>

@code {
    [Parameter] public string NetworkName { get; set; } = "";
    [Parameter] public EventCallback OnClose { get; set; }
    [Parameter] public EventCallback OnNetworkUpdated { get; set; }

    private NetworkDetailsDto? networkDetails;
    private bool isLoading = true;
    private string? errorMessage;
    private string? successMessage;
    private string? disconnectingContainerId;

    protected override async Task OnParametersSetAsync()
    {
        if (!string.IsNullOrEmpty(NetworkName))
        {
            await LoadNetworkDetails();
        }
    }

    private async Task LoadNetworkDetails()
    {
        isLoading = true;
        errorMessage = null;
        successMessage = null;
        StateHasChanged();

        try
        {
            var response = await SwarmService.GetNetworkDetailsAsync(NetworkName);
            if (response.Success)
            {
                networkDetails = response.Data.Network;
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading network details: {ex.Message}");
            errorMessage = "Erreur lors du chargement des details du reseau";
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    private async Task DisconnectContainer(string containerId)
    {
        disconnectingContainerId = containerId;
        errorMessage = null;
        successMessage = null;
        StateHasChanged();

        try
        {
            var request = new DisconnectContainerRequest(ContainerId: containerId, Force: false);
            var response = await SwarmService.DisconnectContainerAsync(NetworkName, request);

            if (response.Success)
            {
                successMessage = "Conteneur deconnecte avec succes";
                await LoadNetworkDetails();
                await OnNetworkUpdated.InvokeAsync();
            }
            else
            {
                errorMessage = "Erreur lors de la deconnexion du conteneur";
            }
        }
        catch (Exception ex)
        {
            errorMessage = ex.Message;
        }
        finally
        {
            disconnectingContainerId = null;
            StateHasChanged();
        }
    }

    private string GetDriverBadgeClass(string driver)
    {
        return driver.ToLowerInvariant() switch
        {
            "overlay" => "bg-purple-100 text-purple-800",
            "bridge" => "bg-blue-100 text-blue-800",
            "host" => "bg-green-100 text-green-800",
            "none" => "bg-gray-100 text-gray-800",
            "macvlan" => "bg-yellow-100 text-yellow-800",
            _ => "bg-gray-100 text-gray-800"
        };
    }
}

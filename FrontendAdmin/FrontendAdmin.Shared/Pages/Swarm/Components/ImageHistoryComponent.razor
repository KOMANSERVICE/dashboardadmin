@using FrontendAdmin.Shared.Pages.Swarm.Models
@inject ISwarmHttpService SwarmService

<div class="p-4">
    @if (isLoading)
    {
        <div class="flex justify-center items-center py-8">
            <i class="fas fa-spinner fa-spin text-2xl text-primary-700"></i>
        </div>
    }
    else if (historyItems.Any())
    {
        <div class="space-y-4">
            <p class="text-sm text-gray-500 mb-4">
                Historique des couches de l'image (du plus recent au plus ancien)
            </p>

            <div class="relative">
                <!-- Timeline line -->
                <div class="absolute left-4 top-0 bottom-0 w-0.5 bg-gray-200"></div>

                @foreach (var (item, index) in historyItems.Select((item, index) => (item, index)))
                {
                    <div class="relative pl-10 pb-6">
                        <!-- Timeline dot -->
                        <div class="absolute left-2.5 w-3 h-3 rounded-full @(index == 0 ? "bg-primary-700" : "bg-gray-300")"></div>

                        <div class="bg-gray-50 rounded-lg p-4">
                            <div class="flex justify-between items-start mb-2">
                                <div class="text-xs text-gray-500">
                                    @item.CreatedAt.ToString("dd/MM/yyyy HH:mm:ss")
                                </div>
                                <span class="px-2 py-1 text-xs font-medium rounded @(item.Size > 0 ? "bg-blue-100 text-blue-800" : "bg-gray-100 text-gray-600")">
                                    @FormatBytes(item.Size)
                                </span>
                            </div>

                            @if (!string.IsNullOrEmpty(item.CreatedBy))
                            {
                                <code class="text-xs text-gray-700 bg-gray-200 px-2 py-1 rounded block overflow-x-auto">
                                    @TruncateCommand(item.CreatedBy)
                                </code>
                            }

                            @if (!string.IsNullOrEmpty(item.Comment))
                            {
                                <p class="text-xs text-gray-600 mt-2 italic">@item.Comment</p>
                            }

                            @if (item.Tags?.Any() == true)
                            {
                                <div class="flex flex-wrap gap-1 mt-2">
                                    @foreach (var tag in item.Tags)
                                    {
                                        <span class="px-2 py-0.5 text-xs bg-green-100 text-green-700 rounded">
                                            @tag
                                        </span>
                                    }
                                </div>
                            }
                        </div>
                    </div>
                }
            </div>
        </div>

        <div class="flex justify-end mt-6">
            <Button type="button" @onclick="() => OnClose.InvokeAsync()"
                    ButtonColor="ButtonColor.Light">
                <span>Fermer</span>
            </Button>
        </div>
    }
    else
    {
        <div class="text-center py-8 text-gray-500">
            <i class="fas fa-history text-2xl mb-2"></i>
            <p>Aucun historique disponible</p>
        </div>
    }
</div>

@code {
    [Parameter] public string ImageId { get; set; } = "";
    [Parameter] public EventCallback OnClose { get; set; }

    private bool isLoading = true;
    private List<ImageHistoryDto> historyItems = new();

    protected override async Task OnInitializedAsync()
    {
        await LoadHistory();
    }

    private async Task LoadHistory()
    {
        if (string.IsNullOrEmpty(ImageId)) return;

        isLoading = true;
        StateHasChanged();

        try
        {
            var response = await SwarmService.GetImageHistoryAsync(ImageId);
            if (response.Success)
            {
                historyItems = response.Data.History;
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading image history: {ex.Message}");
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    private string FormatBytes(long bytes)
    {
        if (bytes == 0) return "0 B";
        string[] sizes = { "B", "KB", "MB", "GB", "TB" };
        int order = 0;
        double size = bytes;
        while (size >= 1024 && order < sizes.Length - 1)
        {
            order++;
            size /= 1024;
        }
        return $"{size:0.##} {sizes[order]}";
    }

    private string TruncateCommand(string command)
    {
        if (string.IsNullOrEmpty(command)) return "";
        // Remove /bin/sh -c prefix if present
        var cleaned = command.Replace("/bin/sh -c ", "").Replace("#(nop) ", "");
        if (cleaned.Length > 100)
        {
            return cleaned[..97] + "...";
        }
        return cleaned;
    }
}

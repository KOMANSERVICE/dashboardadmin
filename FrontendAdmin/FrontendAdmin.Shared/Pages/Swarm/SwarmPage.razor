@page "/swarm"
@using FrontendAdmin.Shared.Pages.Swarm.Models
@using FrontendAdmin.Shared.Pages.Swarm.Components
@inject ISwarmHttpService SwarmService
@inject NavigationManager NavigationManager

<PageTitleComponent Title="Docker Swarm" />

<div class="container mx-auto px-4 py-8">
    <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-8">
        <div>
            <h2 class="text-3xl font-bold text-primary-700 text-gray-900 sm:text-2xl">Docker Swarm</h2>
            <p class="text-gray-600">Gestion des services, noeuds, volumes, conteneurs, reseaux et images du cluster Docker Swarm</p>
        </div>

        <div class="flex gap-2 mt-4 md:mt-0">
            <Button type="button" @onclick="RefreshData" id="refreshBtn"
                    IconCss="fas fa-sync-alt" IconPlacement="ButtonIconPlacement.Left"
                    Disabled="@isLoading">
                <span>Actualiser</span>
            </Button>
            @if (activeTab == 0)
            {
                <Button type="button" @onclick="ShowCreateServiceModal" id="addServiceBtn"
                        IconCss="fas fa-plus" IconPlacement="ButtonIconPlacement.Left">
                    <span>Nouveau service</span>
                </Button>
            }
            else if (activeTab == 2)
            {
                <Button type="button" @onclick="ShowCreateVolumeModal" id="addVolumeBtn"
                        IconCss="fas fa-plus" IconPlacement="ButtonIconPlacement.Left">
                    <span>Nouveau volume</span>
                </Button>
                <Button type="button" @onclick="ShowPruneConfirmation" id="pruneVolumesBtn"
                        ButtonColor="ButtonColor.Warning"
                        IconCss="fas fa-broom" IconPlacement="ButtonIconPlacement.Left">
                    <span>Pruner</span>
                </Button>
            }
            else if (activeTab == 4)
            {
                <Button type="button" @onclick="ShowCreateNetworkModal" id="addNetworkBtn"
                        IconCss="fas fa-plus" IconPlacement="ButtonIconPlacement.Left">
                    <span>Nouveau reseau</span>
                </Button>
                <Button type="button" @onclick="ShowNetworkPruneConfirmation" id="pruneNetworksBtn"
                        ButtonColor="ButtonColor.Warning"
                        IconCss="fas fa-broom" IconPlacement="ButtonIconPlacement.Left">
                    <span>Pruner</span>
                </Button>
            }
            else if (activeTab == 5)
            {
                <Button type="button" @onclick="ShowPullImageModal" id="pullImageBtn"
                        IconCss="fas fa-download" IconPlacement="ButtonIconPlacement.Left">
                    <span>Telecharger</span>
                </Button>
                <Button type="button" @onclick="ShowImagePruneConfirmation" id="pruneImagesBtn"
                        ButtonColor="ButtonColor.Warning"
                        IconCss="fas fa-broom" IconPlacement="ButtonIconPlacement.Left">
                    <span>Pruner</span>
                </Button>
            }
        </div>
    </div>

    <!-- Tabs -->
    <div class="mb-6">
        <div class="border-b border-gray-200">
            <nav class="-mb-px flex space-x-8">
                <button @onclick="() => SetActiveTab(0)"
                        class="@GetTabClass(0) whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">
                    <i class="fas fa-cubes mr-2"></i>
                    Services (@services.Count)
                </button>
                <button @onclick="() => SetActiveTab(1)"
                        class="@GetTabClass(1) whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">
                    <i class="fas fa-server mr-2"></i>
                    Noeuds (@nodes.Count)
                </button>
                <button @onclick="() => SetActiveTab(2)"
                        class="@GetTabClass(2) whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">
                    <i class="fas fa-database mr-2"></i>
                    Volumes (@volumes.Count)
                </button>
                <button @onclick="() => SetActiveTab(3)"
                        class="@GetTabClass(3) whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">
                    <i class="fas fa-cube mr-2"></i>
                    Conteneurs (@containers.Count)
                </button>
                <button @onclick="() => SetActiveTab(4)"
                        class="@GetTabClass(4) whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">
                    <i class="fas fa-network-wired mr-2"></i>
                    Reseaux (@networks.Count)
                </button>
                <button @onclick="() => SetActiveTab(5)"
                        class="@GetTabClass(5) whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">
                    <i class="fas fa-layer-group mr-2"></i>
                    Images (@images.Count)
                </button>
            </nav>
        </div>
    </div>

    @if (isLoading)
    {
        <LoadingData />
    }
    else if (activeTab == 0)
    {
        <!-- Services Tab -->
        <ServiceListComponent Services="@services"
                              OnRefresh="RefreshData"
                              OnViewDetails="ViewServiceDetails"
                              OnViewLogs="ViewServiceLogs"
                              OnScale="ShowScaleDialog"
                              OnRestart="RestartService"
                              OnRollback="RollbackService"
                              OnDelete="ShowDeleteConfirmation"
                              OnResources="ShowResourcesModal" />
    }
    else if (activeTab == 1)
    {
        <!-- Nodes Tab -->
        <NodeListComponent Nodes="@nodes" />
    }
    else if (activeTab == 2)
    {
        <!-- Volumes Tab -->
        <VolumeListComponent Volumes="@volumes"
                             OnRefresh="RefreshData"
                             OnViewDetails="ViewVolumeDetails"
                             OnBackup="ShowBackupModal"
                             OnDelete="ShowVolumeDeleteConfirmation" />
    }
    else if (activeTab == 3)
    {
        <!-- Containers Tab -->
        <ContainerListComponent Containers="@containers"
                                OnRefresh="RefreshData"
                                OnViewDetails="ViewContainerDetails"
                                OnViewStats="ViewContainerStats"
                                OnViewLogs="ViewContainerLogs"
                                OnExec="ShowExecModal" />
    }
    else if (activeTab == 4)
    {
        <!-- Networks Tab -->
        <NetworkListComponent Networks="@networks"
                              OnRefresh="RefreshData"
                              OnViewDetails="ViewNetworkDetails"
                              OnConnect="ShowConnectContainerModal"
                              OnDelete="ShowNetworkDeleteConfirmation" />
    }
    else if (activeTab == 5)
    {
        <!-- Images Tab -->
        <ImageListComponent Images="@images"
                            OnRefresh="RefreshData"
                            OnViewDetails="ViewImageDetails"
                            OnViewHistory="ViewImageHistory"
                            OnTag="ShowTagImageModal"
                            OnPush="ShowPushImageModal"
                            OnDelete="ShowImageDeleteConfirmation" />
    }
</div>

<!-- Service Modals -->
<Modal OnCloseModal="() => showCreateModal = false"
       ShowModal="showCreateModal"
       ModalTitle="Nouveau service Docker">
    <CreateServiceComponent OnServiceCreated="OnServiceCreated"
                            OnCancel="() => showCreateModal = false" />
</Modal>

<Modal OnCloseModal="() => showScaleModal = false"
       ShowModal="showScaleModal"
       ModalTitle="@($"Scaler le service: {selectedServiceName}")">
    <ScaleServiceComponent ServiceName="@selectedServiceName"
                           CurrentReplicas="@selectedServiceReplicas"
                           OnScaled="OnServiceScaled"
                           OnCancel="() => showScaleModal = false" />
</Modal>

<Modal OnCloseModal="() => showLogsModal = false"
       ShowModal="showLogsModal"
       ModalTitle="@($"Logs du service: {selectedServiceName}")">
    <ServiceLogsComponent ServiceName="@selectedServiceName"
                          OnClose="() => showLogsModal = false" />
</Modal>

<Modal OnCloseModal="() => showDetailsModal = false"
       ShowModal="showDetailsModal"
       ModalTitle="@($"Details du service: {selectedServiceName}")">
    <ServiceDetailsComponent ServiceName="@selectedServiceName"
                             OnClose="() => showDetailsModal = false" />
</Modal>

<Modal OnCloseModal="() => showResourcesModal = false"
       ShowModal="showResourcesModal"
       ModalTitle="@($"Ressources du service: {selectedServiceName}")">
    <ServiceResourcesComponent ServiceName="@selectedServiceName"
                               OnSaved="OnResourcesSaved"
                               OnClose="() => showResourcesModal = false" />
</Modal>

<Modal OnCloseModal="() => showDeleteModal = false"
       ShowModal="showDeleteModal"
       ModalTitle="Confirmer la suppression">
    <div class="p-4">
        <p class="text-gray-700 mb-4">
            Etes-vous sur de vouloir supprimer le service <strong>@selectedServiceName</strong> ?
            Cette action est irreversible.
        </p>
        <div class="flex justify-end gap-2">
            <Button type="button" @onclick="() => showDeleteModal = false"
                    ButtonColor="ButtonColor.Light">
                <span>Annuler</span>
            </Button>
            <Button type="button" @onclick="ConfirmDelete"
                    ButtonColor="ButtonColor.Danger"
                    Disabled="@isDeleting">
                @if (isDeleting)
                {
                    <span class="animate-spin mr-2">
                        <i class="fas fa-spinner"></i>
                    </span>
                }
                <span>Supprimer</span>
            </Button>
        </div>
    </div>
</Modal>

<!-- Volume Modals -->
<Modal OnCloseModal="() => showCreateVolumeModal = false"
       ShowModal="showCreateVolumeModal"
       ModalTitle="Nouveau volume Docker">
    <CreateVolumeComponent OnVolumeCreated="OnVolumeCreated"
                           OnCancel="() => showCreateVolumeModal = false" />
</Modal>

<Modal OnCloseModal="() => showVolumeDetailsModal = false"
       ShowModal="showVolumeDetailsModal"
       ModalTitle="@($"Details du volume: {selectedVolumeName}")"
       ModalSize="ModalSize.Large">
    <VolumeDetailsComponent VolumeName="@selectedVolumeName"
                            OnClose="() => showVolumeDetailsModal = false" />
</Modal>

<Modal OnCloseModal="() => showVolumeDeleteModal = false"
       ShowModal="showVolumeDeleteModal"
       ModalTitle="Confirmer la suppression">
    <div class="p-4">
        <p class="text-gray-700 mb-4">
            Etes-vous sur de vouloir supprimer le volume <strong>@selectedVolumeName</strong> ?
            @if (selectedVolumeIsUsed)
            {
                <span class="text-red-600 font-medium">
                    <br />Ce volume est utilise par un ou plusieurs containers.
                </span>
            }
        </p>
        @if (selectedVolumeIsUsed)
        {
            <div class="flex items-center mb-4">
                <input type="checkbox" @bind="forceDeleteVolume" id="forceDelete"
                       class="mr-2 h-4 w-4 text-red-600 focus:ring-red-500 border-gray-300 rounded" />
                <label for="forceDelete" class="text-sm text-gray-700">
                    Forcer la suppression (peut causer des problemes avec les containers)
                </label>
            </div>
        }
        <div class="flex justify-end gap-2">
            <Button type="button" @onclick="() => showVolumeDeleteModal = false"
                    ButtonColor="ButtonColor.Light">
                <span>Annuler</span>
            </Button>
            <Button type="button" @onclick="ConfirmVolumeDelete"
                    ButtonColor="ButtonColor.Danger"
                    Disabled="@(isDeleting || (selectedVolumeIsUsed && !forceDeleteVolume))">
                @if (isDeleting)
                {
                    <span class="animate-spin mr-2">
                        <i class="fas fa-spinner"></i>
                    </span>
                }
                <span>Supprimer</span>
            </Button>
        </div>
    </div>
</Modal>

<Modal OnCloseModal="() => showBackupModal = false"
       ShowModal="showBackupModal"
       ModalTitle="@($"Backup/Restore: {selectedVolumeName}")"
       ModalSize="ModalSize.Large">
    <BackupRestoreComponent VolumeName="@selectedVolumeName"
                            OnClose="() => showBackupModal = false"
                            OnOperationComplete="RefreshData" />
</Modal>

<Modal OnCloseModal="() => showPruneModal = false"
       ShowModal="showPruneModal"
       ModalTitle="Pruner les volumes inutilises">
    <div class="p-4">
        <p class="text-gray-700 mb-4">
            <i class="fas fa-exclamation-triangle text-yellow-500 mr-2"></i>
            Cette action va supprimer tous les volumes non utilises par des containers.
            Cette operation est irreversible.
        </p>
        @if (pruneResult != null)
        {
            <div class="p-3 bg-green-100 text-green-700 rounded-md text-sm mb-4">
                <i class="fas fa-check-circle mr-2"></i>
                @pruneResult.DeletedCount volume(s) supprime(s), @FormatBytes(pruneResult.SpaceReclaimed) recupere(s)
            </div>
        }
        <div class="flex justify-end gap-2">
            <Button type="button" @onclick="() => { showPruneModal = false; pruneResult = null; }"
                    ButtonColor="ButtonColor.Light">
                <span>@(pruneResult != null ? "Fermer" : "Annuler")</span>
            </Button>
            @if (pruneResult == null)
            {
                <Button type="button" @onclick="ConfirmPrune"
                        ButtonColor="ButtonColor.Warning"
                        Disabled="@isPruning">
                    @if (isPruning)
                    {
                        <span class="animate-spin mr-2">
                            <i class="fas fa-spinner"></i>
                        </span>
                    }
                    <span>Pruner</span>
                </Button>
            }
        </div>
    </div>
</Modal>

<!-- Container Modals -->
<Modal OnCloseModal="() => showContainerDetailsModal = false"
       ShowModal="showContainerDetailsModal"
       ModalTitle="@($"Details du conteneur: {selectedContainerName}")">
    <ContainerDetailsComponent ContainerId="@selectedContainerId"
                               OnClose="() => showContainerDetailsModal = false" />
</Modal>

<Modal OnCloseModal="() => showContainerStatsModal = false"
       ShowModal="showContainerStatsModal"
       ModalTitle="@($"Statistiques: {selectedContainerName}")">
    <ContainerStatsComponent ContainerId="@selectedContainerId"
                             OnClose="() => showContainerStatsModal = false" />
</Modal>

<Modal OnCloseModal="() => showContainerLogsModal = false"
       ShowModal="showContainerLogsModal"
       ModalTitle="@($"Logs: {selectedContainerName}")">
    <ContainerLogsComponent ContainerId="@selectedContainerId"
                            OnClose="() => showContainerLogsModal = false" />
</Modal>

<Modal OnCloseModal="() => showContainerExecModal = false"
       ShowModal="showContainerExecModal"
       ModalTitle="@($"Terminal: {selectedContainerName}")">
    <ContainerExecComponent ContainerId="@selectedContainerId"
                            ContainerName="@selectedContainerName"
                            OnClose="() => showContainerExecModal = false" />
</Modal>

<Modal OnCloseModal="() => showContainerTopModal = false"
       ShowModal="showContainerTopModal"
       ModalTitle="@($"Processus: {selectedContainerName}")">
    <ContainerTopComponent ContainerId="@selectedContainerId"
                           OnClose="() => showContainerTopModal = false" />
</Modal>

<Modal OnCloseModal="() => showContainerChangesModal = false"
       ShowModal="showContainerChangesModal"
       ModalTitle="@($"Modifications: {selectedContainerName}")">
    <ContainerChangesComponent ContainerId="@selectedContainerId"
                               OnClose="() => showContainerChangesModal = false" />
</Modal>

<!-- Network Modals -->
<Modal OnCloseModal="() => showCreateNetworkModal = false"
       ShowModal="showCreateNetworkModal"
       ModalTitle="Nouveau reseau Docker">
    <CreateNetworkComponent OnNetworkCreated="OnNetworkCreated"
                            OnCancel="() => showCreateNetworkModal = false" />
</Modal>

<Modal OnCloseModal="() => showNetworkDetailsModal = false"
       ShowModal="showNetworkDetailsModal"
       ModalTitle="@($"Details du reseau: {selectedNetworkName}")">
    <NetworkDetailsComponent NetworkName="@selectedNetworkName"
                             OnClose="() => showNetworkDetailsModal = false"
                             OnNetworkUpdated="RefreshData" />
</Modal>

<Modal OnCloseModal="() => showConnectContainerModal = false"
       ShowModal="showConnectContainerModal"
       ModalTitle="@($"Connecter un conteneur au reseau: {selectedNetworkName}")">
    <ConnectContainerComponent NetworkName="@selectedNetworkName"
                               OnContainerConnected="OnContainerConnected"
                               OnCancel="() => showConnectContainerModal = false" />
</Modal>

<Modal OnCloseModal="() => showNetworkDeleteModal = false"
       ShowModal="showNetworkDeleteModal"
       ModalTitle="Confirmer la suppression">
    <div class="p-4">
        <p class="text-gray-700 mb-4">
            Etes-vous sur de vouloir supprimer le reseau <strong>@selectedNetworkName</strong> ?
            @if (selectedNetworkContainerCount > 0)
            {
                <span class="text-red-600 font-medium">
                    <br />Ce reseau est utilise par @selectedNetworkContainerCount conteneur(s).
                </span>
            }
            Cette action est irreversible.
        </p>
        <div class="flex justify-end gap-2">
            <Button type="button" @onclick="() => showNetworkDeleteModal = false"
                    ButtonColor="ButtonColor.Light">
                <span>Annuler</span>
            </Button>
            <Button type="button" @onclick="ConfirmNetworkDelete"
                    ButtonColor="ButtonColor.Danger"
                    Disabled="@isDeleting">
                @if (isDeleting)
                {
                    <span class="animate-spin mr-2">
                        <i class="fas fa-spinner"></i>
                    </span>
                }
                <span>Supprimer</span>
            </Button>
        </div>
    </div>
</Modal>

<Modal OnCloseModal="() => showNetworkPruneModal = false"
       ShowModal="showNetworkPruneModal"
       ModalTitle="Pruner les reseaux inutilises">
    <div class="p-4">
        <p class="text-gray-700 mb-4">
            <i class="fas fa-exclamation-triangle text-yellow-500 mr-2"></i>
            Cette action va supprimer tous les reseaux non utilises par des containers.
            Les reseaux systeme (bridge, host, none, ingress) ne seront pas affectes.
            Cette operation est irreversible.
        </p>
        @if (networkPruneResult != null)
        {
            <div class="p-3 bg-green-100 text-green-700 rounded-md text-sm mb-4">
                <i class="fas fa-check-circle mr-2"></i>
                @networkPruneResult.DeletedCount reseau(x) supprime(s)
            </div>
        }
        <div class="flex justify-end gap-2">
            <Button type="button" @onclick="() => { showNetworkPruneModal = false; networkPruneResult = null; }"
                    ButtonColor="ButtonColor.Light">
                <span>@(networkPruneResult != null ? "Fermer" : "Annuler")</span>
            </Button>
            @if (networkPruneResult == null)
            {
                <Button type="button" @onclick="ConfirmNetworkPrune"
                        ButtonColor="ButtonColor.Warning"
                        Disabled="@isNetworkPruning">
                    @if (isNetworkPruning)
                    {
                        <span class="animate-spin mr-2">
                            <i class="fas fa-spinner"></i>
                        </span>
                    }
                    <span>Pruner</span>
                </Button>
            }
        </div>
    </div>
</Modal>

<!-- Image Modals -->
<Modal OnCloseModal="() => showPullImageModal = false"
       ShowModal="showPullImageModal"
       ModalTitle="Telecharger une image Docker">
    <PullImageComponent OnImagePulled="OnImagePulled"
                        OnCancel="() => showPullImageModal = false" />
</Modal>

<Modal OnCloseModal="() => showImageDetailsModal = false"
       ShowModal="showImageDetailsModal"
       ModalTitle="@($"Details de l'image: {selectedImageName}")"
       ModalSize="ModalSize.Large">
    <ImageDetailsComponent ImageId="@selectedImageId"
                           OnClose="() => showImageDetailsModal = false" />
</Modal>

<Modal OnCloseModal="() => showImageHistoryModal = false"
       ShowModal="showImageHistoryModal"
       ModalTitle="@($"Historique de l'image: {selectedImageName}")"
       ModalSize="ModalSize.Large">
    <ImageHistoryComponent ImageId="@selectedImageId"
                           OnClose="() => showImageHistoryModal = false" />
</Modal>

<Modal OnCloseModal="() => showTagImageModal = false"
       ShowModal="showTagImageModal"
       ModalTitle="Taguer une image">
    <TagImageComponent ImageId="@selectedImageId"
                       SourceImage="@selectedImageName"
                       OnImageTagged="OnImageTagged"
                       OnCancel="() => showTagImageModal = false" />
</Modal>

<Modal OnCloseModal="() => showPushImageModal = false"
       ShowModal="showPushImageModal"
       ModalTitle="Pousser une image">
    <PushImageComponent ImageId="@selectedImageId"
                        SourceImage="@selectedImageName"
                        OnImagePushed="OnImagePushed"
                        OnCancel="() => showPushImageModal = false" />
</Modal>

<Modal OnCloseModal="() => showImageDeleteModal = false"
       ShowModal="showImageDeleteModal"
       ModalTitle="Confirmer la suppression">
    <div class="p-4">
        <p class="text-gray-700 mb-4">
            Etes-vous sur de vouloir supprimer l'image <strong>@selectedImageName</strong> ?
            @if (selectedImageContainerCount > 0)
            {
                <span class="text-red-600 font-medium">
                    <br />Cette image est utilisee par @selectedImageContainerCount conteneur(s).
                </span>
            }
        </p>
        @if (selectedImageContainerCount > 0)
        {
            <div class="flex items-center mb-4">
                <input type="checkbox" @bind="forceDeleteImage" id="forceDeleteImage"
                       class="mr-2 h-4 w-4 text-red-600 focus:ring-red-500 border-gray-300 rounded" />
                <label for="forceDeleteImage" class="text-sm text-gray-700">
                    Forcer la suppression (peut causer des problemes avec les containers)
                </label>
            </div>
        }
        <div class="flex justify-end gap-2">
            <Button type="button" @onclick="() => showImageDeleteModal = false"
                    ButtonColor="ButtonColor.Light">
                <span>Annuler</span>
            </Button>
            <Button type="button" @onclick="ConfirmImageDelete"
                    ButtonColor="ButtonColor.Danger"
                    Disabled="@(isDeleting || (selectedImageContainerCount > 0 && !forceDeleteImage))">
                @if (isDeleting)
                {
                    <span class="animate-spin mr-2">
                        <i class="fas fa-spinner"></i>
                    </span>
                }
                <span>Supprimer</span>
            </Button>
        </div>
    </div>
</Modal>

<Modal OnCloseModal="() => showImagePruneModal = false"
       ShowModal="showImagePruneModal"
       ModalTitle="Pruner les images inutilisees">
    <div class="p-4">
        <p class="text-gray-700 mb-4">
            <i class="fas fa-exclamation-triangle text-yellow-500 mr-2"></i>
            Cette action va supprimer toutes les images dangling (non taguees).
            Cette operation est irreversible.
        </p>
        @if (imagePruneResult != null)
        {
            <div class="p-3 bg-green-100 text-green-700 rounded-md text-sm mb-4">
                <i class="fas fa-check-circle mr-2"></i>
                @imagePruneResult.DeletedCount image(s) supprimee(s), @FormatBytes(imagePruneResult.SpaceReclaimed) recupere(s)
            </div>
        }
        <div class="flex justify-end gap-2">
            <Button type="button" @onclick="() => { showImagePruneModal = false; imagePruneResult = null; }"
                    ButtonColor="ButtonColor.Light">
                <span>@(imagePruneResult != null ? "Fermer" : "Annuler")</span>
            </Button>
            @if (imagePruneResult == null)
            {
                <Button type="button" @onclick="ConfirmImagePrune"
                        ButtonColor="ButtonColor.Warning"
                        Disabled="@isImagePruning">
                    @if (isImagePruning)
                    {
                        <span class="animate-spin mr-2">
                            <i class="fas fa-spinner"></i>
                        </span>
                    }
                    <span>Pruner</span>
                </Button>
            }
        </div>
    </div>
</Modal>

@code {
    private List<SwarmServiceDto> services = new();
    private List<NodeDto> nodes = new();
    private List<VolumeDto> volumes = new();
    private List<ContainerDto> containers = new();
    private List<NetworkDto> networks = new();
    private List<ImageDto> images = new();
    private bool isLoading = true;
    private int activeTab = 0;

    // Service state
    private bool showCreateModal;
    private bool showScaleModal;
    private bool showLogsModal;
    private bool showDetailsModal;
    private bool showDeleteModal;
    private bool showResourcesModal;
    private bool isDeleting;
    private string selectedServiceName = "";
    private int selectedServiceReplicas;

    // Volume state
    private bool showCreateVolumeModal;
    private bool showVolumeDetailsModal;
    private bool showVolumeDeleteModal;
    private bool showBackupModal;
    private bool showPruneModal;
    private bool isPruning;
    private string selectedVolumeName = "";
    private bool selectedVolumeIsUsed;
    private bool forceDeleteVolume;
    private PruneVolumesResponse? pruneResult;

    // Container state
    private bool showContainerDetailsModal;
    private bool showContainerStatsModal;
    private bool showContainerLogsModal;
    private bool showContainerExecModal;
    private bool showContainerTopModal;
    private bool showContainerChangesModal;
    private string selectedContainerId = "";
    private string selectedContainerName = "";

    // Network state
    private bool showCreateNetworkModal;
    private bool showNetworkDetailsModal;
    private bool showConnectContainerModal;
    private bool showNetworkDeleteModal;
    private bool showNetworkPruneModal;
    private bool isNetworkPruning;
    private string selectedNetworkName = "";
    private int selectedNetworkContainerCount;
    private PruneNetworksResponse? networkPruneResult;

    // Image state
    private bool showPullImageModal;
    private bool showImageDetailsModal;
    private bool showImageHistoryModal;
    private bool showTagImageModal;
    private bool showPushImageModal;
    private bool showImageDeleteModal;
    private bool showImagePruneModal;
    private bool isImagePruning;
    private string selectedImageId = "";
    private string selectedImageName = "";
    private int selectedImageContainerCount;
    private bool forceDeleteImage;
    private PruneImagesResponse? imagePruneResult;

    protected override async Task OnInitializedAsync()
    {
        await RefreshData();
    }

    private async Task RefreshData()
    {
        isLoading = true;
        StateHasChanged();

        try
        {
            var servicesTask = SwarmService.GetServicesAsync();
            var nodesTask = SwarmService.GetNodesAsync();
            var volumesTask = SwarmService.GetVolumesAsync();
            var containersTask = SwarmService.GetContainersAsync();
            var networksTask = SwarmService.GetNetworksAsync();
            var imagesTask = SwarmService.GetImagesAsync();

            await Task.WhenAll(servicesTask, nodesTask, volumesTask, containersTask, networksTask, imagesTask);

            var servicesResponse = await servicesTask;
            var nodesResponse = await nodesTask;
            var volumesResponse = await volumesTask;
            var containersResponse = await containersTask;
            var networksResponse = await networksTask;
            var imagesResponse = await imagesTask;

            if (servicesResponse.Success)
                services = servicesResponse.Data.Services;

            if (nodesResponse.Success)
                nodes = nodesResponse.Data.Nodes;

            if (volumesResponse.Success)
                volumes = volumesResponse.Data.Volumes;

            if (containersResponse.Success)
                containers = containersResponse.Data.Containers;

            if (networksResponse.Success)
                networks = networksResponse.Data.Networks;

            if (imagesResponse.Success)
                images = imagesResponse.Data.Images;
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading Swarm data: {ex.Message}");
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    private void SetActiveTab(int tab)
    {
        activeTab = tab;
    }

    private string GetTabClass(int tab)
    {
        return activeTab == tab
            ? "border-primary-700 text-primary-700"
            : "border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300";
    }

    // Service methods
    private void ShowCreateServiceModal()
    {
        showCreateModal = true;
    }

    private async Task OnServiceCreated()
    {
        showCreateModal = false;
        await RefreshData();
    }

    private void ViewServiceDetails(string serviceName)
    {
        selectedServiceName = serviceName;
        showDetailsModal = true;
    }

    private void ViewServiceLogs(string serviceName)
    {
        selectedServiceName = serviceName;
        showLogsModal = true;
    }

    private void ShowScaleDialog(SwarmServiceDto service)
    {
        selectedServiceName = service.Name;
        selectedServiceReplicas = service.DesiredReplicas;
        showScaleModal = true;
    }

    private async Task OnServiceScaled()
    {
        showScaleModal = false;
        await RefreshData();
    }

    private async Task RestartService(string serviceName)
    {
        try
        {
            await SwarmService.RestartServiceAsync(serviceName);
            await RefreshData();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error restarting service: {ex.Message}");
        }
    }

    private async Task RollbackService(string serviceName)
    {
        try
        {
            await SwarmService.RollbackServiceAsync(serviceName);
            await RefreshData();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error rolling back service: {ex.Message}");
        }
    }

    private void ShowDeleteConfirmation(string serviceName)
    {
        selectedServiceName = serviceName;
        showDeleteModal = true;
    }

    private void ShowResourcesModal(string serviceName)
    {
        selectedServiceName = serviceName;
        showResourcesModal = true;
    }

    private async Task OnResourcesSaved()
    {
        showResourcesModal = false;
        await RefreshData();
    }

    private async Task ConfirmDelete()
    {
        isDeleting = true;
        StateHasChanged();

        try
        {
            await SwarmService.DeleteServiceAsync(selectedServiceName);
            showDeleteModal = false;
            await RefreshData();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error deleting service: {ex.Message}");
        }
        finally
        {
            isDeleting = false;
            StateHasChanged();
        }
    }

    // Volume methods
    private void ShowCreateVolumeModal()
    {
        showCreateVolumeModal = true;
    }

    private async Task OnVolumeCreated()
    {
        showCreateVolumeModal = false;
        await RefreshData();
    }

    private void ViewVolumeDetails(string volumeName)
    {
        selectedVolumeName = volumeName;
        showVolumeDetailsModal = true;
    }

    private void ShowBackupModal(string volumeName)
    {
        selectedVolumeName = volumeName;
        showBackupModal = true;
    }

    private void ShowVolumeDeleteConfirmation(VolumeDto volume)
    {
        selectedVolumeName = volume.Name;
        selectedVolumeIsUsed = volume.IsUsed;
        forceDeleteVolume = false;
        showVolumeDeleteModal = true;
    }

    private async Task ConfirmVolumeDelete()
    {
        isDeleting = true;
        StateHasChanged();

        try
        {
            await SwarmService.DeleteVolumeAsync(selectedVolumeName, forceDeleteVolume);
            showVolumeDeleteModal = false;
            await RefreshData();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error deleting volume: {ex.Message}");
        }
        finally
        {
            isDeleting = false;
            StateHasChanged();
        }
    }

    private void ShowPruneConfirmation()
    {
        pruneResult = null;
        showPruneModal = true;
    }

    private async Task ConfirmPrune()
    {
        isPruning = true;
        StateHasChanged();

        try
        {
            var response = await SwarmService.PruneVolumesAsync();
            if (response.Success)
            {
                pruneResult = response.Data;
                await RefreshData();
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error pruning volumes: {ex.Message}");
        }
        finally
        {
            isPruning = false;
            StateHasChanged();
        }
    }

    private string FormatBytes(long bytes)
    {
        string[] sizes = { "B", "KB", "MB", "GB", "TB" };
        int order = 0;
        double size = bytes;
        while (size >= 1024 && order < sizes.Length - 1)
        {
            order++;
            size /= 1024;
        }
        return $"{size:0.##} {sizes[order]}";
    }

    // Container methods
    private void ViewContainerDetails(ContainerDto container)
    {
        selectedContainerId = container.Id;
        selectedContainerName = container.Name;
        showContainerDetailsModal = true;
    }

    private void ViewContainerStats(ContainerDto container)
    {
        selectedContainerId = container.Id;
        selectedContainerName = container.Name;
        showContainerStatsModal = true;
    }

    private void ViewContainerLogs(ContainerDto container)
    {
        selectedContainerId = container.Id;
        selectedContainerName = container.Name;
        showContainerLogsModal = true;
    }

    private void ShowExecModal(ContainerDto container)
    {
        selectedContainerId = container.Id;
        selectedContainerName = container.Name;
        showContainerExecModal = true;
    }

    // Network methods
    private void ShowCreateNetworkModal()
    {
        showCreateNetworkModal = true;
    }

    private async Task OnNetworkCreated()
    {
        showCreateNetworkModal = false;
        await RefreshData();
    }

    private void ViewNetworkDetails(string networkName)
    {
        selectedNetworkName = networkName;
        showNetworkDetailsModal = true;
    }

    private void ShowConnectContainerModal(NetworkDto network)
    {
        selectedNetworkName = network.Name;
        showConnectContainerModal = true;
    }

    private async Task OnContainerConnected()
    {
        showConnectContainerModal = false;
        await RefreshData();
    }

    private void ShowNetworkDeleteConfirmation(NetworkDto network)
    {
        selectedNetworkName = network.Name;
        selectedNetworkContainerCount = network.ContainerCount;
        showNetworkDeleteModal = true;
    }

    private async Task ConfirmNetworkDelete()
    {
        isDeleting = true;
        StateHasChanged();

        try
        {
            await SwarmService.DeleteNetworkAsync(selectedNetworkName);
            showNetworkDeleteModal = false;
            await RefreshData();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error deleting network: {ex.Message}");
        }
        finally
        {
            isDeleting = false;
            StateHasChanged();
        }
    }

    private void ShowNetworkPruneConfirmation()
    {
        networkPruneResult = null;
        showNetworkPruneModal = true;
    }

    private async Task ConfirmNetworkPrune()
    {
        isNetworkPruning = true;
        StateHasChanged();

        try
        {
            var response = await SwarmService.PruneNetworksAsync();
            if (response.Success)
            {
                networkPruneResult = response.Data;
                await RefreshData();
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error pruning networks: {ex.Message}");
        }
        finally
        {
            isNetworkPruning = false;
            StateHasChanged();
        }
    }

    // Image methods
    private void ShowPullImageModal()
    {
        showPullImageModal = true;
    }

    private async Task OnImagePulled()
    {
        showPullImageModal = false;
        await RefreshData();
    }

    private void ViewImageDetails(string imageId)
    {
        var image = images.FirstOrDefault(i => i.Id == imageId);
        selectedImageId = imageId;
        selectedImageName = image != null ? $"{image.Repository ?? "<none>"}:{image.Tag ?? "<none>"}" : imageId;
        showImageDetailsModal = true;
    }

    private void ViewImageHistory(string imageId)
    {
        var image = images.FirstOrDefault(i => i.Id == imageId);
        selectedImageId = imageId;
        selectedImageName = image != null ? $"{image.Repository ?? "<none>"}:{image.Tag ?? "<none>"}" : imageId;
        showImageHistoryModal = true;
    }

    private void ShowTagImageModal(ImageDto image)
    {
        selectedImageId = image.Id;
        selectedImageName = $"{image.Repository ?? "<none>"}:{image.Tag ?? "<none>"}";
        showTagImageModal = true;
    }

    private async Task OnImageTagged()
    {
        showTagImageModal = false;
        await RefreshData();
    }

    private void ShowPushImageModal(ImageDto image)
    {
        selectedImageId = image.Id;
        selectedImageName = $"{image.Repository ?? "<none>"}:{image.Tag ?? "<none>"}";
        showPushImageModal = true;
    }

    private async Task OnImagePushed()
    {
        showPushImageModal = false;
        await RefreshData();
    }

    private void ShowImageDeleteConfirmation(ImageDto image)
    {
        selectedImageId = image.Id;
        selectedImageName = $"{image.Repository ?? "<none>"}:{image.Tag ?? "<none>"}";
        selectedImageContainerCount = image.ContainerCount;
        forceDeleteImage = false;
        showImageDeleteModal = true;
    }

    private async Task ConfirmImageDelete()
    {
        isDeleting = true;
        StateHasChanged();

        try
        {
            await SwarmService.DeleteImageAsync(selectedImageId, forceDeleteImage);
            showImageDeleteModal = false;
            await RefreshData();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error deleting image: {ex.Message}");
        }
        finally
        {
            isDeleting = false;
            StateHasChanged();
        }
    }

    private void ShowImagePruneConfirmation()
    {
        imagePruneResult = null;
        showImagePruneModal = true;
    }

    private async Task ConfirmImagePrune()
    {
        isImagePruning = true;
        StateHasChanged();

        try
        {
            var response = await SwarmService.PruneImagesAsync();
            if (response.Success)
            {
                imagePruneResult = response.Data;
                await RefreshData();
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error pruning images: {ex.Message}");
        }
        finally
        {
            isImagePruning = false;
            StateHasChanged();
        }
    }
}

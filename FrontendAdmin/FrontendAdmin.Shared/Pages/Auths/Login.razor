@page "/"
@page "/Login"

@inject IAuthService _authService
@inject NavigationManager _navigationManager
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject IAuthService AuthService
@inject IAuthHttpService _authHttpService


@layout NoContentLayout

<section class="bg-gray-50 min-h-screen flex items-center justify-center">
    <div class="login-container w-full max-w-md mx-4">
        <div class="bg-white rounded-xl shadow-2xl p-8 border border-gray-100">
            <div class="text-center mb-8">
                <div class="w-16 h-16 bg-primary-700 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i class="fas fa-lock text-white text-2xl"></i>
                </div>
                <h1 class="text-2xl font-bold text-gray-800">AdminFlow Pro</h1>
                <p class="text-gray-600 mt-2">Acces securise au backoffice</p>
            </div>
            <EditForm EditContext="@editContext" OnValidSubmit="HandleLogin" >
                <DataAnnotationsValidator />

                <ErrorsSummary editContext="@editContext" />

                <div class="space-y-6">

                    <TextInput @bind-Value="signInModel.Email"
                               Label="Nom d'utilisateur" Placeholder="votre@email.com"
                               IconCss="fas fa-envelope text-gray-400"
                               For="() => signInModel.Email" />


                    <PasswordInput @bind-Value="signInModel.Password"
                               Label="Mot de passe" Placeholder="********"
                                For="() => signInModel.Password" />
                                                   
                    <div class="flex items-center justify-between">
                        <label class="flex items-center">
                            <InputCheckbox @bind-Value="signInModel.RememberMe" class="h-4 w-4 text-primary-600 focus:ring-primary-500 border-gray-300 rounded" />
                            <span class="ml-2 text-sm text-gray-600">Se souvenir de moi</span>
                        </label>
                        <a href="#" class="text-sm text-primary-600 hover:text-primary-500 transition">Mot de passe oublie ?</a>
                    </div>
                    <Button Type="submit" IsLoading="@isLoading">
                        Se connecter
                    </Button>
                </div>

            </EditForm>

            <div class="mt-6 text-center">
                <p class="text-sm text-gray-600">Version 2.1.0 - 2024 AdminFlow Pro</p>
            </div>
        </div>
    </div>

</section>

@code {
    private bool isLoading;
    private SignIn signInModel = new();

    private EditContext editContext = default!;
    private ValidationMessageStore messageStore = default!;

    protected override void OnInitialized()
    {
        editContext = new EditContext(signInModel);
        messageStore = new ValidationMessageStore(editContext);

        editContext.OnValidationRequested += (s, e) => messageStore.Clear();
        editContext.OnFieldChanged += (s, e) => messageStore.Clear(e.FieldIdentifier);
    }

    private async Task HandleLogin()
    {
        try
        {
            var request = await _authHttpService.SignIn(new SignInRequest(signInModel));
            var isConnected = await _authService.SetTokenAsync(request.Data.Token, signInModel.RememberMe);
            if (isConnected)
            {
                var query = System.Web.HttpUtility.ParseQueryString(new Uri(_navigationManager.Uri).Query);
                var returnUrl = query["returnUrl"] ?? "/list-app";

                _navigationManager.NavigateTo(returnUrl);
            }
            else
            {

                ApiErrorHandler.ApplyApiErrors<SignIn>(messageStore, editContext, "Identifiants invalides.");
                editContext.NotifyValidationStateChanged();
            }

        }
        catch (ApiException ex)
        {
            ApiErrorHandler.ApplyApiErrors<SignIn>(messageStore, editContext, ex.Content);
            editContext.NotifyValidationStateChanged();
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }
}


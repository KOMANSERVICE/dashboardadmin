@using FrontendAdmin.Shared.Pages.ApiKeys.Models
@inject IApiKeyHttpService ApiKeyService

<LoadingPage IsLoad="@isLoading" />

<EditForm EditContext="@editContext" OnValidSubmit="HandleSubmit">
    <DataAnnotationsValidator />
    <ErrorsSummary editContext="@editContext" />

    <div class="p-6 space-y-4">
        <div class="bg-yellow-50 border-l-4 border-yellow-400 p-4 mb-4">
            <div class="flex">
                <div class="flex-shrink-0">
                    <i class="fas fa-exclamation-triangle text-yellow-400"></i>
                </div>
                <div class="ml-3">
                    <p class="text-sm text-yellow-700">
                        <strong>Important:</strong> L'API Key ne sera affichee qu'une seule fois apres sa creation.
                        Assurez-vous de la copier et de la stocker en lieu sur.
                    </p>
                </div>
            </div>
        </div>

        <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Scopes (Permissions)</label>
            <div class="space-y-2 max-h-64 overflow-y-auto border rounded-lg p-3">
                @foreach (var scope in ApiKeyScopes.AllScopes)
                {
                    <label class="flex items-start space-x-3 p-2 hover:bg-gray-50 rounded cursor-pointer">
                        <input type="checkbox"
                               checked="@selectedScopes.Contains(scope.Value)"
                               @onchange="() => ToggleScope(scope.Value)"
                               class="h-4 w-4 text-primary-600 focus:ring-primary-500 border-gray-300 rounded mt-1" />
                        <div>
                            <span class="text-sm font-medium text-gray-900">@scope.Label</span>
                            <p class="text-xs text-gray-500">@scope.Description</p>
                        </div>
                    </label>
                }
            </div>
            @if (selectedScopes.Count == 0)
            {
                <p class="mt-1 text-sm text-red-600">Selectionnez au moins un scope</p>
            }
        </div>

        <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Date d'expiration (optionnel)</label>
            <input type="date"
                   @bind="expirationDate"
                   min="@DateTime.Today.AddDays(1).ToString("yyyy-MM-dd")"
                   class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-primary-500 focus:border-primary-500 sm:text-sm" />
            <p class="mt-1 text-xs text-gray-500">Laissez vide pour une cle sans expiration (non recommande)</p>
        </div>
    </div>

    <div class="flex justify-end gap-3 px-6 py-4 border-t">
        <Button aria-label="Annuler"
                ButtonClass="border border-gray-300 bg-white rounded-lg text-gray-700 hover:bg-gray-50"
                type="button"
                @onclick="HandleCancel">
            Annuler
        </Button>
        <Button aria-label="Creer"
                type="submit"
                disabled="@(selectedScopes.Count == 0 || isLoading)">
            Creer l'API Key
        </Button>
    </div>
</EditForm>

@code {
    [Parameter]
    public string ApplicationId { get; set; } = string.Empty;

    [Parameter]
    public EventCallback<ApiKeyCreatedResponse> OnApiKeyCreated { get; set; }

    [Parameter]
    public EventCallback OnCancel { get; set; }

    private bool isLoading;
    private HashSet<string> selectedScopes = new();
    private DateTime? expirationDate;
    private CreateApiKeyRequest request = new();
    private EditContext editContext = null!;
    private ValidationMessageStore messageStore = null!;

    protected override void OnInitialized()
    {
        editContext = new EditContext(request);
        messageStore = new ValidationMessageStore(editContext);
    }

    private void ToggleScope(string scope)
    {
        if (selectedScopes.Contains(scope))
        {
            selectedScopes.Remove(scope);
        }
        else
        {
            selectedScopes.Add(scope);
        }
    }

    private void HandleCancel()
    {
        OnCancel.InvokeAsync();
    }

    private async Task HandleSubmit()
    {
        if (selectedScopes.Count == 0)
        {
            return;
        }

        isLoading = true;
        try
        {
            var createRequest = new CreateApiKeyRequest
            {
                ApplicationId = ApplicationId,
                ApplicationName = ApplicationId, // Will be resolved by backend
                Scopes = selectedScopes.ToArray(),
                ExpiresAt = expirationDate?.ToUniversalTime()
            };

            var response = await ApiKeyService.CreateApiKeyAsync(createRequest);
            if (response.Success && response.Data?.ApiKey != null)
            {
                await OnApiKeyCreated.InvokeAsync(response.Data.ApiKey);
            }
        }
        catch (ApiException ex)
        {
            ApiErrorHandler.ApplyApiErrors<CreateApiKeyRequest>(messageStore, editContext, ex.Content);
            editContext.NotifyValidationStateChanged();
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }
}

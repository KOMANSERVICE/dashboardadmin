@page "/api-keys/{ApplicationId}"
@using FrontendAdmin.Shared.Pages.ApiKeys.Models
@using FrontendAdmin.Shared.Pages.ApiKeys.Components
@inject IApiKeyHttpService ApiKeyService
@inject NavigationManager NavigationManager

<PageTitleComponent Title="Gestion des API Keys" />

<div class="container mx-auto px-4 py-8">
    <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-8">
        <div>
            <h2 class="text-3xl font-bold text-primary-700 text-gray-900 sm:text-2xl">API Keys</h2>
            <p class="text-gray-600">Gerez les cles d'API pour votre application</p>
        </div>

        <div class="flex gap-2">
            <Button type="button" @onclick="GoBack"
                    ButtonClass="border border-gray-300 bg-white rounded-lg text-gray-700 hover:bg-gray-50"
                    IconCss="fas fa-arrow-left" IconPlacement="ButtonIconPlacement.Left">
                <span>Retour</span>
            </Button>
            <Button type="button" @onclick="ToggleCreateModal"
                    IconCss="fas fa-plus" IconPlacement="ButtonIconPlacement.Left">
                <span>Nouvelle API Key</span>
            </Button>
        </div>
    </div>

    @if (isLoading)
    {
        <LoadingData />
    }
    else if (apiKeys.Count == 0)
    {
        <div class="text-center py-12">
            <div class="text-gray-400 text-6xl mb-4">
                <i class="fas fa-key"></i>
            </div>
            <h3 class="text-xl font-semibold text-gray-700 mb-2">Aucune API Key</h3>
            <p class="text-gray-500 mb-4">Creez votre premiere API Key pour commencer a integrer vos services.</p>
            <Button type="button" @onclick="ToggleCreateModal"
                    IconCss="fas fa-plus" IconPlacement="ButtonIconPlacement.Left">
                <span>Creer une API Key</span>
            </Button>
        </div>
    }
    else
    {
        <div class="bg-white shadow-md rounded-lg overflow-hidden">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Hash (Prefixe)</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Scopes</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Statut</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Creee le</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Expire le</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Derniere utilisation</th>
                        <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                    @foreach (var apiKey in apiKeys)
                    {
                        <tr class="hover:bg-gray-50">
                            <td class="px-6 py-4 whitespace-nowrap">
                                <code class="text-sm bg-gray-100 px-2 py-1 rounded">@GetHashPrefix(apiKey.ApiKeyHash)</code>
                            </td>
                            <td class="px-6 py-4">
                                <div class="flex flex-wrap gap-1">
                                    @foreach (var scope in apiKey.Scopes.Take(3))
                                    {
                                        <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-blue-100 text-blue-800">
                                            @scope
                                        </span>
                                    }
                                    @if (apiKey.Scopes.Length > 3)
                                    {
                                        <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-gray-100 text-gray-600">
                                            +@(apiKey.Scopes.Length - 3)
                                        </span>
                                    }
                                </div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium @apiKey.StatusClass">
                                    @apiKey.StatusText
                                </span>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                @apiKey.CreatedAt.ToString("dd/MM/yyyy HH:mm")
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                @(apiKey.ExpiresAt?.ToString("dd/MM/yyyy") ?? "Jamais")
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                @(apiKey.LastUsedAt?.ToString("dd/MM/yyyy HH:mm") ?? "Jamais")
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                                @if (!apiKey.IsRevoked)
                                {
                                    <button type="button" @onclick="() => OpenRotateModal(apiKey)"
                                            class="text-blue-600 hover:text-blue-900 mr-3" title="Rotation">
                                        <i class="fas fa-sync-alt"></i>
                                    </button>
                                    <button type="button" @onclick="() => OpenRevokeModal(apiKey)"
                                            class="text-red-600 hover:text-red-900" title="Revoquer">
                                        <i class="fas fa-ban"></i>
                                    </button>
                                }
                                else
                                {
                                    <span class="text-gray-400 italic text-xs">@apiKey.RevokedReason</span>
                                }
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    }
</div>

<!-- Create API Key Modal -->
<Modal OnCloseModal="ToggleCreateModal"
       ShowModal="showCreateModal"
       ModalTitle="Nouvelle API Key">
    <CreateApiKeyComponent ApplicationId="@ApplicationId"
                           OnApiKeyCreated="OnApiKeyCreated"
                           OnCancel="ToggleCreateModal" />
</Modal>

<!-- API Key Secret Modal (shown once after creation) -->
<Modal OnCloseModal="CloseSecretModal"
       ShowModal="showSecretModal"
       ModalTitle="API Key Creee">
    <ApiKeySecretComponent ApiKey="@createdApiKey"
                           OnClose="CloseSecretModal" />
</Modal>

<!-- Revoke Modal -->
<Modal OnCloseModal="CloseRevokeModal"
       ShowModal="showRevokeModal"
       ModalTitle="Revoquer l'API Key">
    <RevokeApiKeyComponent ApiKeyHash="@selectedApiKey?.ApiKeyHash"
                           OnRevoked="OnApiKeyRevoked"
                           OnCancel="CloseRevokeModal" />
</Modal>

<!-- Rotate Modal -->
<Modal OnCloseModal="CloseRotateModal"
       ShowModal="showRotateModal"
       ModalTitle="Rotation de l'API Key">
    <RotateApiKeyComponent ApiKeyHash="@selectedApiKey?.ApiKeyHash"
                           OnRotated="OnApiKeyRotated"
                           OnCancel="CloseRotateModal" />
</Modal>

@code {
    [Parameter]
    public string ApplicationId { get; set; } = string.Empty;

    private List<ApiKeyInfo> apiKeys = new();
    private bool isLoading = true;
    private bool showCreateModal;
    private bool showSecretModal;
    private bool showRevokeModal;
    private bool showRotateModal;
    private ApiKeyCreatedResponse? createdApiKey;
    private ApiKeyInfo? selectedApiKey;

    protected override async Task OnInitializedAsync()
    {
        await LoadApiKeysAsync();
    }

    private async Task LoadApiKeysAsync()
    {
        isLoading = true;
        try
        {
            var response = await ApiKeyService.GetApiKeysByApplicationAsync(ApplicationId);
            if (response.Success)
            {
                apiKeys = response.Data.ApiKeys;
            }
        }
        catch (Exception)
        {
            // Handle error
        }
        finally
        {
            isLoading = false;
        }
    }

    private string GetHashPrefix(string hash)
    {
        return hash.Length > 12 ? $"{hash[..12]}..." : hash;
    }

    private void GoBack()
    {
        NavigationManager.NavigateTo("/list-app");
    }

    private void ToggleCreateModal() => showCreateModal = !showCreateModal;

    private void CloseSecretModal()
    {
        showSecretModal = false;
        createdApiKey = null;
    }

    private void OpenRevokeModal(ApiKeyInfo apiKey)
    {
        selectedApiKey = apiKey;
        showRevokeModal = true;
    }

    private void CloseRevokeModal()
    {
        showRevokeModal = false;
        selectedApiKey = null;
    }

    private void OpenRotateModal(ApiKeyInfo apiKey)
    {
        selectedApiKey = apiKey;
        showRotateModal = true;
    }

    private void CloseRotateModal()
    {
        showRotateModal = false;
        selectedApiKey = null;
    }

    private async Task OnApiKeyCreated(ApiKeyCreatedResponse response)
    {
        showCreateModal = false;
        createdApiKey = response;
        showSecretModal = true;
        await LoadApiKeysAsync();
    }

    private async Task OnApiKeyRevoked()
    {
        CloseRevokeModal();
        await LoadApiKeysAsync();
    }

    private async Task OnApiKeyRotated(ApiKeyCreatedResponse response)
    {
        CloseRotateModal();
        createdApiKey = response;
        showSecretModal = true;
        await LoadApiKeysAsync();
    }
}

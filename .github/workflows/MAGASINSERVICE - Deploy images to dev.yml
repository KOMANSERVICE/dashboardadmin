name: MAGASINSERVICE - Deploy images to dev

on:
  workflow_dispatch:
  workflow_run:
    workflows: ["MAGASINSERVICE - Build and Push Docker Images"]
    types: [completed]

jobs:
  deploy:
    if: ${{ github.event_name != 'workflow_run' || github.event.workflow_run.conclusion == 'success' }}
    permissions:
      actions: read
    uses: ./.github/workflows/reusable-deploy.yml
    with:
      service_name: magasinservice
      image_name: magasinservice
      deploy_path: /home/komanatse/magasinservice
      compose_file: docker-compose.magasinservice.yml
      environment: dev
      ssh_port: 2222
      build_workflow_name: "MAGASINSERVICE - Build and Push Docker Images"
      stack_name: magasin
    secrets:
      SSH_HOST: ${{ secrets.SSH_HOST }}
      SSH_USER: ${{ secrets.SSH_USER }}
      SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
      SSH_PASSPHRASE: ${{ secrets.SSH_PASSPHRASE }}
      DOCKERHUB_TOKEN: ${{ secrets.DOCKERHUB_TOKEN }}
      ENV_CONTENT: |
        POSTGRES_PASSWORD_MAGASIN=${{ secrets.POSTGRES_PASSWORD_MAGASIN_PROD }}
        POSTGRES_DB_MAGASIN=${{ secrets.POSTGRES_DB_MAGASIN_PROD }}
        POSTGRES_USER_MAGASIN=${{ secrets.POSTGRES_USER_MAGASIN_PROD }}
        VAULT_URI=${{ secrets.VAULT_URI }}
        VAULT_ROLE_ID=${{ secrets.VAULT_ROLE_ID_PROD }}
        VAULT_SECRET_ID=${{ secrets.VAULT_SECRET_ID_PROD }}
        VAULT_MOUNT_POINT=${{ secrets.VAULT_MOUNT_POINT }}
        JWT_VALID_AUDIENCE_API=${{ secrets.JWT_VALID_AUDIENCE_API }}
        JWT_VALID_ISSUER_API=${{ secrets.JWT_VALID_ISSUER_API }}
        JWT_SECRET_API=${{ secrets.JWT_SECRET_API }}
        CORS_ALLOWED_ORIGINS=${{ secrets.CORS_ALLOWED_ORIGINS }}
        CONNECTION_STRING_API=${{ secrets.CONNECTION_STRING_API }}
        VAULT_PATH_MOUNT_POINT_MAGASIN=${{ secrets.VAULT_PATH_MOUNT_POINT_MAGASIN }}

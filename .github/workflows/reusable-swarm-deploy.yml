name: Reusable Swarm Deploy

on:
  workflow_call:
    inputs:
      stack_name:
        required: true
        type: string
        description: "Nom de la stack Swarm (menu, magasin, tresorerie, backendadmin)"
      compose_file:
        required: true
        type: string
        description: "Nom du fichier docker-compose"
      deploy_dir:
        required: false
        type: string
        default: '/opt/deploy'
        description: "RÃ©pertoire de dÃ©ploiement sur le VPS"
      version_tag:
        required: true
        type: string
        description: "Tag de version Ã  dÃ©ployer"
    secrets:
      VPS_HOST:
        required: true
      VPS_USER:
        required: true
      VPS_SSH_KEY:
        required: true
      DOCKERHUB_TOKEN:
        required: true

jobs:
  deploy:
    name: Deploy to Swarm
    runs-on: ubuntu-latest
    steps:
      - name: Deploy to VPS via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          script: |
            set -e
            
            STACK_NAME="${{ inputs.stack_name }}"
            COMPOSE_FILE="${{ inputs.compose_file }}"
            DEPLOY_DIR="${{ inputs.deploy_dir }}/$STACK_NAME"
            VERSION_TAG="${{ inputs.version_tag }}"
            
            echo "ðŸš€ DÃ©ploiement de $STACK_NAME (version: $VERSION_TAG)..."
            
            cd "$DEPLOY_DIR"
            
            # Mettre Ã  jour DOCKER_TAG dans le .env
            if [ -f .env ]; then
              sed -i "s/^DOCKER_TAG=.*/DOCKER_TAG=$VERSION_TAG/" .env
              # Si DOCKER_TAG n'existe pas, l'ajouter
              grep -q "^DOCKER_TAG=" .env || echo "DOCKER_TAG=$VERSION_TAG" >> .env
            fi
            
            # Login Docker Hub
            echo "${{ secrets.DOCKERHUB_TOKEN }}" | docker login -u komanatse --password-stdin
            
            # Pull les nouvelles images
            docker compose -f "$COMPOSE_FILE" pull --quiet
            
            # GÃ©nÃ©rer le fichier rÃ©solu compatible Swarm
            docker compose -f "$COMPOSE_FILE" config | \
              sed 's/published: "\([0-9]*\)"/published: \1/g' | \
              sed '/host_ip:/d' | \
              sed '/^name:/d' > /tmp/stack-resolved.yml
            
            # DÃ©ployer/Mettre Ã  jour la stack
            docker stack deploy \
              -c /tmp/stack-resolved.yml \
              --with-registry-auth \
              --prune \
              "$STACK_NAME"
            
            # Nettoyer
            rm -f /tmp/stack-resolved.yml
            
            echo "âœ… $STACK_NAME dÃ©ployÃ© avec succÃ¨s"
            
            # Afficher le statut
            echo ""
            echo "ðŸ“Š Statut des services:"
            sleep 3
            docker service ls --filter "name=${STACK_NAME}_"

  health-check:
    name: Health Check
    needs: deploy
    runs-on: ubuntu-latest
    steps:
      - name: Wait for services to stabilize
        run: sleep 30
      
      - name: Check service health
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          script: |
            STACK_NAME="${{ inputs.stack_name }}"
            
            echo "ðŸ¥ VÃ©rification de santÃ© de $STACK_NAME..."
            
            # VÃ©rifier que tous les services sont healthy
            UNHEALTHY=$(docker service ls --filter "name=${STACK_NAME}_" --format "{{.Name}} {{.Replicas}}" | grep -v "1/1\|2/2\|0/0" || true)
            
            if [ -n "$UNHEALTHY" ]; then
              echo "âš ï¸ Services en problÃ¨me:"
              echo "$UNHEALTHY"
              
              # Afficher les logs des services en erreur
              echo "$UNHEALTHY" | awk '{print $1}' | while read svc; do
                echo "--- Logs de $svc ---"
                docker service logs --tail 50 "$svc" 2>&1 || true
              done
              
              exit 1
            fi
            
            echo "âœ… Tous les services de $STACK_NAME sont healthy"
